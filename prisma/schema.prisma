generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === USUARIOS ===
model User {
  id            String    @id
  email         String    @unique
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())

  // Campos de administración
  isBanned      Boolean   @default(false)
  banReason     String?
  bannedUntil   DateTime? // null = ban permanente, fecha = ban temporal
  isSilenced    Boolean   @default(false) // Silenciado (no puede publicar)
  silencedUntil DateTime? // null = silencio permanente, fecha = temporal

  // Perfiles
  workerProfile    WorkerProfile?
  companyProfile   CompanyProfile?
  foremanProfile   ForemanProfile?
  engineerProfile  EngineerProfile?
  encargadoProfile  EncargadoProfile?
  tractoristProfile TractoristProfile?

  // Actividad
  posts           Post[]           @relation("UserPosts")
  applications    Application[]    // Ofertas a las que se ha inscrito
  likes           Like[]          @relation("PostLikes")
  shares          Share[]         @relation("PostShares")

  // Sistema de Compañeros (Relación N a N)
  followedBy      Connection[]  @relation("followedBy")
  following       Connection[]  @relation("following")

  // Mensajería
  sentMessages      Message[]     @relation("MessageSender")
  receivedMessages  Message[]     @relation("MessageReceiver")
  conversations    ConversationParticipant[]

  // Notificaciones
  notifications     Notification[]

  // Denuncias (reportado por otros usuarios)
  reportsReceived   Report[]   @relation("ReportedUser")
  reportsFiled     Report[]   @relation("Reporter")

  // Notificaciones donde este usuario es la entidad relacionada
  notificationsAsRelated Notification[] @relation("NotificationUser")
}

enum Role {
  USER       // Trabajador
  ADMIN
  COMPANY    // Empresa
  FOREMAN    // Manijero
  ENGINEER   // Ingeniero Técnico Agrícola
  ENCARGADO  // Capataz/Encargado de finca
  TRACTORISTA// Tractorista
}

// === PERFILES ===
model WorkerProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])

  fullName    String?
  city        String?
  province    String?
  phone       String?
  experience  String[]
  bio         String?
  hasVehicle  Boolean  @default(false)
  canRelocate Boolean  @default(false)
  foodHandler Boolean  @default(false)
  phytosanitaryLevel String?

  // Experiencia en maquinaria y herramientas
  machineryExperience String[]
  yearsExperience    Int?
  canWorkAway        Boolean  @default(false)

  // Tipos de carnet (multi-selección)
  licenseTypes String[]

  // Control de modificación de nombre (60 días)
  nameLastModified DateTime?

  // Foto de perfil (URL de Firebase Storage)
  profileImage String?
}

model ForemanProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])

  fullName    String
  phone       String
  province    String
  city        String?
  crewSize    Int
  workArea    String[]
  hasVan      Boolean  @default(false)
  needsBus    Boolean  @default(false)
  ownTools    Boolean  @default(false)
  yearsExperience Int?
  specialties     String[]
  bio             String?

  // Control de modificación de nombre (60 días)
  nameLastModified DateTime?

  // Foto de perfil (URL de Firebase Storage)
  profileImage String?
}

model CompanyProfile {
  id             String   @id @default(uuid())
  userId         String   @unique
  user           User     @relation(fields: [userId], references: [id])

  cif            String   @unique
  companyName    String
  address        String?
  city           String?
  province       String?
  phone          String?
  contactPerson   String?
  website        String?
  description    String?

  // Aprobación de empresa (requerida para publicar ofertas)
  isApproved     Boolean  @default(false) // Debe ser aprobada por admin para publicar ofertas
  approvedAt     DateTime?            // Fecha de aprobación
  approvedBy     String?             // UID del admin que aprobó

  // Verificación de empresa
  isVerified     Boolean  @default(false) // Solo visible como "verificada" si esto es true
  verifiedAt     DateTime?
  verifiedBy     String? // UID del admin que verificó

  // Foto de perfil (logo de empresa - URL de Firebase Storage)
  profileImage   String?

  posts          Post[]
}

model EngineerProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])

  // Información básica
  fullName          String?
  phone             String?
  province          String?
  city              String?
  bio               String?

  // Credenciales legales
  collegiateNumber  String? // Número de colegiado

  // Experiencia profesional
  yearsExperience  Int?     // Años de experiencia
  cropExperience   String[] // Tipos de cultivo en los que tiene experiencia (Fresa, Cítricos, Arándanos, etc.)

  // Especialidades y servicios
  specialties      String[] // Ej: Gestión de riego, Fitopatología, Nutrición vegetal, etc.
  servicesOffered  String[] // Ej: Asesoramiento, Peritajes, Auditorías, Formación, etc.

  // Disponibilidad
  isAvailable       Boolean  @default(true) // ¿Está disponible para nuevos proyectos?
  canTravel          Boolean  @default(false) // ¿Puede desplazarse a otras provincias?

  // Foto de perfil (URL de Firebase Storage)
  profileImage      String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model EncargadoProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])

  // Información básica
  fullName          String?
  phone             String?
  province          String?
  city              String?
  bio               String?

  // Experiencia laboral
  yearsExperience   Int?     // Años de experiencia como encargado

  // Experiencia en maquinaria
  canDriveTractor   Boolean  @default(false) // ¿Puede manejar tractor?

  // Experiencia por cultivos
  cropExperience    String[] // Tipos de cultivo en los que tiene experiencia

  // Disponibilidad de alojamiento
  needsAccommodation Boolean @default(false) // ¿Necesita alojamiento en finca?

  // Disponibilidad geográfica
  workArea          String[] // Provincias donde puede trabajar

  // Carnets y certificaciones
  phytosanitaryLevel String? // Nivel fitosanitario
  foodHandler       Boolean  @default(false)

  // Control de modificación de nombre (60 días)
  nameLastModified DateTime?

  // Foto de perfil
  profileImage      String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

model TractoristProfile {
  id                String   @id @default(uuid())
  userId            String   @unique
  user              User     @relation(fields: [userId], references: [id])

  // Información básica
  fullName          String?
  phone             String?
  province          String?
  city              String?
  bio               String?

  // Experiencia profesional
  yearsExperience   Int?     // Años de experiencia como tractorista

  // Tipos de maquinaria que maneja (tractores, cosechadoras, etc.)
  machineryTypes    String[]

  // Tipos de aperos que maneja (arado, grada, sembradora, etc.)
  toolTypes         String[]

  // Experiencia por cultivos
  cropExperience    String[] // Tipos de cultivo en los que tiene experiencia

  // Carnets específicos
  hasTractorLicense    Boolean @default(false) // Carnet de tractor
  hasSprayerLicense    Boolean @default(false) // Carnet de pulverizadora
  hasHarvesterLicense  Boolean @default(false) // Carnet de cosechadora

  // Disponibilidad
  isAvailableSeason   Boolean @default(true) // ¿Disponible para temporada completa?
  canTravel           Boolean @default(false) // ¿Puede desplazarse?

  // Carnets generales
  phytosanitaryLevel  String? // Nivel fitosanitario
  foodHandler         Boolean @default(false)

  // Control de modificación de nombre (60 días)
  nameLastModified DateTime?

  // Foto de perfil
  profileImage      String?

  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
}

// === PUBLICACIONES (OFERTAS Y DEMANDAS) ===
model Post {
  id          String   @id @default(uuid())
  title       String
  description String
  location    String
  province    String?

  type        PostType @default(SHARED)
  taskType    String? // Tipo de tarea: Recolección, Plantación, Poda, etc. (para demandas)

  // Campos para ofertas de empleo (solo para OFICIAL y SHARED)
  contractType    String?  // Tipo de contrato: Eventual, Fijo discontinuo, Indefinido, etc.
  providesAccommodation Boolean? // Si ofrece alojamiento
  salaryAmount    String?  // Cantidad salarial (texto libre para flexibilidad)
  salaryPeriod    String?  // Periodo de salario: HORA, JORNADA, MENSUAL, ANUAL
  hoursPerWeek    Int?     // Horas semanales (jornada)
  startDate       String?  // Fecha de inicio estimada
  endDate         String?  // Fecha de fin (para contratos eventuales)

  // Contadores
  likesCount     Int      @default(0)
  sharesCount    Int      @default(0)

  // Moderación
  status      PostStatus @default(ACTIVE) // ACTIVE, HIDDEN, REMOVED
  moderatedBy String? // UID del admin que moderó
  moderatedAt DateTime?
  moderationReason String?

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Autor
  publisherId String?
  publisher   User?    @relation("UserPosts", fields: [publisherId], references: [id])

  // Si es oficial de empresa
  companyId   String?
  company     CompanyProfile? @relation(fields: [companyId], references: [id])

  // Relaciones
  applications Application[]
  reports     Report[]   @relation("ReportedPost")
  conversations Conversation[] @relation("PostConversations")
  notifications Notification[] @relation("NotificationPost")
  likes        Like[]
  shares       Share[]
}

enum PostType {
  OFFICIAL // Oferta de Empresa (Verificada)
  SHARED  // Oferta vista allí (Compartida por trabajador)
  DEMAND  // Demanda (Trabajador/Manijero pide trabajo)
}

enum PostStatus {
  ACTIVE   // Visible en el feed
  HIDDEN   // Oculto temporalmente (puede reactivarse)
  REMOVED  // Eliminado (no se puede recuperar)
}

// === INSCRIPCIONES ===
model Application {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  status    ApplicationStatus @default(PENDING)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([postId, userId]) // No puedes inscribirte 2 veces a la misma
}

enum ApplicationStatus {
  PENDING     // Recién inscrito
  ACCEPTED    // Empresa marca como interesante
  REJECTED    // Empresa descarta al candidato
  CONTACTED   // Empresa ya contactó al candidato
  WITHDRAWN   // Candidato se retira
}

// === LIKES ===
model Like {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  userId    String
  user      User     @relation("PostLikes", fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([postId, userId]) // Un usuario solo puede dar like una vez
}

// === SHARES (Compartidos) ===
model Share {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  userId    String
  user      User     @relation("PostShares", fields: [userId], references: [id])
  createdAt DateTime @default(now())

  @@unique([postId, userId]) // Un usuario solo puede compartir una vez
}

// === COMPAÑEROS / CONEXIONES ===
model Connection {
  id          String   @id @default(uuid())
  followerId  String
  follower    User     @relation("following", fields: [followerId], references: [id])
  followingId String
  following   User     @relation("followedBy", fields: [followingId], references: [id])
  status      String   @default("ACCEPTED") // Podría ser PENDING si queremos confirmación

  createdAt   DateTime  @default(now())

  @@unique([followerId, followingId])
}

// === DENUNCIAS ===
model Report {
  id          String   @id @default(uuid())
  type        ReportType

  // Quién denuncia
  reporterId  String
  reporter    User     @relation("Reporter", fields: [reporterId], references: [id])

  // Qué se denuncia (opcional según el tipo)
  reportedUserId  String?
  reportedUser    User?    @relation("ReportedUser", fields: [reportedUserId], references: [id])
  reportedPostId  String?
  reportedPost    Post?    @relation("ReportedPost", fields: [reportedPostId], references: [id])

  reason      String // Razón de la denuncia
  description String? // Descripción adicional

  // Estado y resolución
  status      ReportStatus @default(PENDING)
  resolvedBy   String? // UID del admin que resolvió
  resolvedAt   DateTime?
  resolution   String? // Nota sobre la resolución

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

enum ReportType {
  USER     // Denunciar usuario
  POST     // Denunciar publicación
}

enum ReportStatus {
  PENDING    // Pendiente de revisión
  REVIEWED   // Revisado (en proceso)
  RESOLVED   // Resuelto
  DISMISSED  // Desestimado (sin acción)
}

// === LOG DE ACCIONES DE ADMIN ===
model AdminLog {
  id          String   @id @default(uuid())
  adminId     String // UID del admin
  action      AdminAction
  targetType   String // "USER", "POST", "COMPANY", "REPORT"
  targetId    String // ID del objeto afectado
  details     String? // Detalles adicionales (JSON)
  createdAt   DateTime @default(now())
}

enum AdminAction {
  BAN_USER
  UNBAN_USER
  SILENCE_USER
  UNSILENCE_USER
  VERIFY_COMPANY
  UNVERIFY_COMPANY
  HIDE_POST
  SHOW_POST
  REMOVE_POST
  RESOLVE_REPORT
  DELETE_USER
  CHANGE_ROLE
}

// === MENSAJERÍA INTERNA ===
model Conversation {
  id          String   @id @default(uuid())
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Participantes de la conversación
  participants ConversationParticipant[]

  // Mensajes de la conversación
  messages    Message[]

  // Relacionado con (opcional) - post que originó la conversación
  relatedPostId String?
  relatedPost   Post?    @relation("PostConversations", fields: [relatedPostId], references: [id])
}

model ConversationParticipant {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  userId         String
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Control de lectura
  lastReadAt     DateTime?

  createdAt      DateTime     @default(now())

  @@unique([conversationId, userId])
}

model Message {
  id             String       @id @default(uuid())
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  senderId       String
  sender         User         @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)

  receiverId     String       // Desnormalizado para facilitar búsquedas
  receiver       User         @relation("MessageReceiver", fields: [receiverId], references: [id], onDelete: Cascade)

  content        String
  isRead         Boolean      @default(false)
  readAt         DateTime?

  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([senderId])
  @@index([receiverId])
}

// === NOTIFICACIONES ===
model Notification {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  type        NotificationType
  title       String
  message     String
  link        String? // URL a la que lleva la notificación

  // Relación con la entidad que genera la notificación (opcional)
  relatedPostId  String?
  relatedPost    Post?    @relation("NotificationPost", fields: [relatedPostId], references: [id])
  relatedUserId  String?
  relatedUser    User?    @relation("NotificationUser", fields: [relatedUserId], references: [id])

  isRead      Boolean  @default(false)
  readAt      DateTime?

  createdAt   DateTime  @default(now())

  @@index([userId])
  @@index([userId, isRead])
}

enum NotificationType {
  NEW_MESSAGE       // Nuevo mensaje en chat
  NEW_APPLICATION   // Alguien se aplicó a tu oferta
  APPLICATION_ACCEPTED // Te aceptaron para un trabajo
  POST_NEARBY      // Nueva oferta cerca de tu ubicación
  PROFILE_VIEW      // Alguien vio tu perfil
  COMPANY_VERIFIED // Empresa verificada (para la empresa)
  ADMIN_ACTION      // Acción de administrador
  POST_LIKE         // Alguien dio like a tu publicación
  POST_SHARE        // Alguien compartió tu publicación
}

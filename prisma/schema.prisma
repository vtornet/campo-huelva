generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// === USUARIOS ===
model User {
  id            String    @id
  email         String    @unique
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  
  // Perfiles
  workerProfile   WorkerProfile?
  companyProfile  CompanyProfile?
  foremanProfile  ForemanProfile?

  // Actividad
  posts           Post[]           @relation("UserPosts")
  applications    Application[]    // Ofertas a las que se ha inscrito
  
  // Sistema de Compañeros (Relación N a N)
  followedBy      Connection[]  @relation("followedBy")
  following       Connection[]  @relation("following")
}

enum Role {
  USER      // Trabajador
  ADMIN
  COMPANY   // Empresa
  FOREMAN   // Manijero
}

// === PERFILES ===
model WorkerProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  
  fullName    String?
  city        String?
  province    String?
  phone       String?
  experience  String[]
  bio         String?
  hasVehicle  Boolean  @default(false)
  canRelocate Boolean  @default(false)
  foodHandler Boolean  @default(false)
  phytosanitaryLevel String?
}

model ForemanProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  fullName    String
  phone       String
  province    String
  city        String?
  crewSize    Int
  workArea    String[]
  hasVan      Boolean  @default(false)
  needsBus    Boolean  @default(false)
  ownTools    Boolean  @default(false)
  yearsExperience Int?
  specialties     String[]
  bio             String?
}

model CompanyProfile {
  id          String   @id @default(cuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])
  cif         String   @unique
  companyName String
  posts       Post[]
}

// === PUBLICACIONES (OFERTAS Y DEMANDAS) ===
// Hemos renombrado 'Offer' a 'Post' para que sea más genérico
model Post {
  id          String   @id @default(cuid())
  title       String
  description String
  location    String   
  province    String?  
  
  type        PostType @default(SHARED) // El tipo define si es Oferta o Demanda
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Autor
  publisherId String?
  publisher   User?    @relation("UserPosts", fields: [publisherId], references: [id])
  
  // Si es oficial de empresa
  companyId   String?
  company     CompanyProfile? @relation(fields: [companyId], references: [id])

  applications Application[]
}

enum PostType {
  OFFICIAL // Oferta de Empresa (Verificada)
  SHARED   // Oferta vista por ahí (Compartida por trabajador)
  DEMAND   // Demanda (Trabajador/Manijero pide trabajo)
}

// === INSCRIPCIONES ===
model Application {
  id        String   @id @default(cuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id])
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  status    String   @default("PENDING") // PENDING, ACCEPTED, REJECTED
  createdAt DateTime @default(now())

  @@unique([postId, userId]) // No puedes inscribirte 2 veces a la misma
}

// === COMPAÑEROS / CONEXIONES ===
model Connection {
  id          String   @id @default(cuid())
  followerId  String
  follower    User     @relation("following", fields: [followerId], references: [id])
  followingId String
  following   User     @relation("followedBy", fields: [followingId], references: [id])
  status      String   @default("ACCEPTED") // Podría ser PENDING si queremos confirmación

  createdAt   DateTime @default(now())
  @@unique([followerId, followingId])
}
